{% extends "base_fixed.html" %}

{% block title %}Monthly Report - {{ profile.full_name if user_type != 'admin' else 'System' }}{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .chart-container canvas {
        max-height: 400px !important;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .stat-card h3 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: bold;
    }
    
    .stat-card p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .month-selector {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
        color: #666;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">
                        <i class="fas fa-chart-line me-2"></i>Monthly Report
                    </h1>
                    <p class="text-muted mb-0">
                        {% if user_type == 'vendor' %}
                            {{ profile.full_name }} ({{ profile.vendor_id }})
                        {% elif user_type == 'manager' %}
                            {{ profile.full_name }} - {{ profile.team_name }}
                        {% else %}
                            System Overview
                        {% endif %}
                    </p>
                </div>
                <div>
                    <button class="btn btn-success me-2" onclick="downloadReport()">
                        <i class="fas fa-download me-1"></i>Download Excel
                    </button>
                    <button class="btn btn-outline-primary" onclick="refreshReport()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Month Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="month-selector">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="monthSelect" class="form-label mb-0">Select Month:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="month" class="form-control" id="monthSelect" 
                               value="{{ selected_month }}" onchange="changeMonth()">
                    </div>
                    <div class="col-md-5">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Choose a month to view detailed attendance analytics
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading report data...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-message d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorMessage">An error occurred while loading the report.</span>
    </div>

    <!-- Report Content -->
    <div id="reportContent" class="d-none">
        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 class="mb-3">
                    <i class="fas fa-chart-bar me-2"></i>Monthly Summary
                </h3>
                <div class="summary-grid" id="summaryStats">
                    <!-- Dynamic stats will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-pie-chart me-2"></i>Attendance Status Breakdown
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle me-2"></i>Approval Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="approvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>Daily Attendance Timeline
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Detailed Records
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Status</th>
                                        <th>Location</th>
                                        <th>Approval</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Dynamic data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
let currentMonth = '{{ selected_month }}';
let reportData = null;
let statusChart = null;
let approvalChart = null;
let timelineChart = null;

// Load report data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadReportData();
});

function loadReportData() {
    showLoading();
    
    fetch(`/api/monthly-report-data?month=${currentMonth}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                reportData = data;
                displayReport();
            } else {
                showError(data.error || 'Failed to load report data');
            }
        })
        .catch(error => {
            console.error('Error loading report:', error);
            showError('Network error: Unable to load report data');
        });
}

function displayReport() {
    hideLoading();
    
    // Update summary stats
    updateSummaryStats();
    
    // Create charts
    createStatusChart();
    createApprovalChart();
    createTimelineChart();
    
    // Update data table
    updateDataTable();
    
    // Show report content
    document.getElementById('reportContent').classList.remove('d-none');
}

function updateSummaryStats() {
    const summary = reportData.summary;
    const statusBreakdown = reportData.status_breakdown;
    
    // Count office days and WFH days
    let officeDays = 0;
    let wfhDays = 0;
    
    for (const [status, count] of Object.entries(statusBreakdown)) {
        if (status.includes('office')) {
            officeDays += count;
        } else if (status.includes('wfh')) {
            wfhDays += count;
        }
    }
    
    const summaryHTML = `
        <div class="stat-card">
            <h3>${summary.attendance_rate}%</h3>
            <p>Attendance Rate</p>
        </div>
        <div class="stat-card">
            <h3>${summary.submitted_days}</h3>
            <p>Days Submitted</p>
        </div>
        <div class="stat-card">
            <h3>${officeDays}</h3>
            <p>Office Days</p>
        </div>
        <div class="stat-card">
            <h3>${wfhDays}</h3>
            <p>WFH Days</p>
        </div>
        <div class="stat-card">
            <h3>${summary.pending_approvals}</h3>
            <p>Pending Approvals</p>
        </div>
    `;
    
    document.getElementById('summaryStats').innerHTML = summaryHTML;
}

function createStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (statusChart) {
        statusChart.destroy();
    }
    
    const statusData = reportData.status_breakdown;
    const labels = Object.keys(statusData).map(key => key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()));
    const data = Object.values(statusData);
    
    const colors = [
        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
    ];
    
    statusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, data.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((context.raw / total) * 100);
                            return `${context.label}: ${context.raw} days (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createApprovalChart() {
    const ctx = document.getElementById('approvalChart').getContext('2d');
    
    if (approvalChart) {
        approvalChart.destroy();
    }
    
    const approvalData = reportData.approval_breakdown;
    
    approvalChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Pending', 'Rejected'],
            datasets: [{
                data: [approvalData.approved, approvalData.pending, approvalData.rejected],
                backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createTimelineChart() {
    const ctx = document.getElementById('timelineChart').getContext('2d');
    
    if (timelineChart) {
        timelineChart.destroy();
    }
    
    const dailyData = reportData.daily_data;
    const dates = dailyData.map(d => d.date);
    const statusValues = dailyData.map(d => {
        // Convert status to numeric value for timeline
        if (d.status.includes('office')) return 2;
        if (d.status.includes('wfh')) return 1;
        if (d.status.includes('leave')) return 0;
        return -1; // absent
    });
    
    timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Attendance Pattern',
                data: statusValues,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 2.5,
                    ticks: {
                        callback: function(value) {
                            if (value === 2) return 'Office';
                            if (value === 1) return 'WFH';
                            if (value === 0) return 'Leave';
                            if (value === -1) return 'Absent';
                            return '';
                        }
                    }
                },
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MMM dd'
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const daily = dailyData[context.dataIndex];
                            return `${daily.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())} at ${daily.location}`;
                        }
                    }
                }
            }
        }
    });
}

function updateDataTable() {
    const tbody = document.getElementById('attendanceTableBody');
    const dailyData = reportData.daily_data;
    
    tbody.innerHTML = dailyData.map(record => {
        const date = new Date(record.date);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const statusFormatted = record.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        let statusBadge = '';
        if (record.status.includes('office')) {
            statusBadge = `<span class="badge bg-success">${statusFormatted}</span>`;
        } else if (record.status.includes('wfh')) {
            statusBadge = `<span class="badge bg-info">${statusFormatted}</span>`;
        } else if (record.status.includes('leave')) {
            statusBadge = `<span class="badge bg-secondary">${statusFormatted}</span>`;
        } else {
            statusBadge = `<span class="badge bg-danger">${statusFormatted}</span>`;
        }
        
        return `
            <tr>
                <td>${record.date}</td>
                <td>${dayName}</td>
                <td>${statusBadge}</td>
                <td>${record.location}</td>
                <td><span class="badge bg-warning">Pending</span></td>
            </tr>
        `;
    }).join('');
}

function changeMonth() {
    currentMonth = document.getElementById('monthSelect').value;
    loadReportData();
}

function refreshReport() {
    loadReportData();
}

function downloadReport() {
    window.open(`/api/export/monthly-report?month=${currentMonth}&format=excel`, '_blank');
}

function showLoading() {
    document.getElementById('loadingState').classList.remove('d-none');
    document.getElementById('errorState').classList.add('d-none');
    document.getElementById('reportContent').classList.add('d-none');
}

function hideLoading() {
    document.getElementById('loadingState').classList.add('d-none');
}

function showError(message) {
    hideLoading();
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').classList.remove('d-none');
    document.getElementById('reportContent').classList.add('d-none');
}
</script>
{% endblock %}
