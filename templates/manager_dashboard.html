{% extends "base_fixed.html" %}

{% block title %}Manager Dashboard - VendorTime{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-users me-2"></i>Manager Dashboard</h2>
            <div>
                <a class="btn btn-outline-primary me-2" href="{{ url_for('profile') }}">
                    <i class="fas fa-user-cog me-1"></i>Profile
                </a>
                <button class="btn btn-info" onclick="generateReport()">
                    <i class="fas fa-download me-1"></i>Export Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Team Overview Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Team Members</h6>
                        <h4 class="mb-0">{{ team_stats.total_members or 8 }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Present Today</h6>
                        <h4 class="mb-0">{{ team_stats.present_today or 6 }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Pending Approvals</h6>
                        <h4 class="mb-0">{{ team_stats.pending_approvals or 4 }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Issues & Mismatches</h6>
                        <h4 class="mb-0">{{ team_stats.mismatches or 2 }}</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Team Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Team Status - Today ({{ today_date }})</h5>
                <button class="btn btn-sm btn-outline-light" onclick="refreshTeamStatus()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Status</th>
                                <th>Hours</th>
                                <th>Location</th>
                                <th>Submitted At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status_item in today_statuses %}
                            {% set vendor = status_item.vendor %}
                            {% set status = status_item.status %}
                            {% set has_mismatch = status_item.has_mismatch %}
                            <tr {% if has_mismatch %}class="table-warning"{% endif %}>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-{% if has_mismatch %}danger{% elif status and status.approval_status.value == 'approved' %}success{% elif status %}info{% else %}warning{% endif %} me-2">
                                            {{ vendor.vendor_id[:2] }}
                                        </div>
                                        <div>
                                            <strong>{{ vendor.full_name }}</strong><br>
                                            <small class="text-muted">{{ vendor.user_account.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if status %}
                                        {% if status.status.value == 'in_office_full' %}
                                            <span class="badge bg-success">In Office - Full</span>
                                        {% elif status.status.value == 'in_office_half' %}
                                            <span class="badge bg-success">In Office - Half</span>
                                        {% elif status.status.value == 'wfh_full' %}
                                            <span class="badge bg-info">WFH - Full</span>
                                        {% elif status.status.value == 'wfh_half' %}
                                            <span class="badge bg-info">WFH - Half</span>
                                        {% elif status.status.value == 'leave_full' %}
                                            <span class="badge bg-secondary">Leave - Full</span>
                                        {% elif status.status.value == 'leave_half' %}
                                            <span class="badge bg-secondary">Leave - Half</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ status.status.value.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">Not Submitted</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if status and status.total_hours %}
                                        <small class="text-success"><strong>{{ "%.1f"|format(status.total_hours) }}h</strong></small>
                                        {% if status.extra_hours and status.extra_hours > 0 %}
                                            <br><small class="text-warning">(+{{ "%.1f"|format(status.extra_hours) }}h extra)</small>
                                        {% endif %}
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>{{ status.location if status else '-' }}</td>
                                <td>
                                    {% if status %}
                                        {{ status.submitted_at.strftime('%I:%M %p') if status.submitted_at else '-' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if status %}
                                        {% if status.approval_status.value == 'pending' %}
                                            <button class="btn btn-sm btn-success me-1" onclick="approveStatus({{ status.id }})"
                                                    title="Approve Status">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger me-1" onclick="rejectStatus({{ status.id }})"
                                                    title="Reject Status">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% elif status.approval_status.value == 'approved' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Approved
                                            </span>
                                        {% elif status.approval_status.value == 'rejected' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Rejected
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>Awaiting Submission
                                        </span>
                                    {% endif %}
                                    
                                    <button class="btn btn-sm btn-outline-primary ms-1" onclick="viewDetails('{{ vendor.vendor_id }}')"
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    
                    {% if has_mismatch %}
                                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="viewMismatches('{{ vendor.vendor_id }}')"
                                                title="View Mismatches">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </button>
                                        <a class="btn btn-sm btn-outline-info ms-1" href="/manager/mismatches/table?vendor={{ vendor.vendor_id }}"
                                                title="View in Table Format">
                                            <i class="fas fa-table"></i>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-2x mb-2"></i><br>
                                    No team members found. Please add vendors to your team.
                                </td>
            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Approvals & Issues -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-hourglass-half me-2"></i>Pending Approvals</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pending_statuses and pending_statuses|length > 0 %}
                                {% for s in pending_statuses %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input pending-checkbox" type="checkbox" value="{{ s.id }}" id="chk-{{ s.id }}">
                                            <label class="form-check-label" for="chk-{{ s.id }}">
                                                <strong>{{ s.vendor.full_name }}</strong>
                                                <small class="text-muted">({{ s.vendor.vendor_id }})</small>
                                            </label>
                                        </div>
                                    </td>
                                    <td>{{ s.status_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if s.status.value == 'in_office_full' %}
                                            <span class="badge bg-success">In Office - Full</span>
                                        {% elif s.status.value == 'in_office_half' %}
                                            <span class="badge bg-success">In Office - Half</span>
                                        {% elif s.status.value == 'wfh_full' %}
                                            <span class="badge bg-info">WFH - Full</span>
                                        {% elif s.status.value == 'wfh_half' %}
                                            <span class="badge bg-info">WFH - Half</span>
                                        {% elif s.status.value == 'leave_full' %}
                                            <span class="badge bg-secondary">Leave - Full</span>
                                        {% elif s.status.value == 'leave_half' %}
                                            <span class="badge bg-secondary">Leave - Half</span>
                                        {% else %}
                                            <span class="badge bg-danger">{{ s.status.value.replace('_',' ') }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ s.location or '-' }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-success" onclick="approveStatus({{ s.id }})">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="rejectStatus({{ s.id }})">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">No pending approvals.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success me-2" onclick="bulkApproveAll()">
                        <i class="fas fa-check-double me-1"></i>Approve All
                    </button>
                    <button class="btn btn-outline-danger" onclick="bulkRejectAll()">
                        <i class="fas fa-times-circle me-1"></i>Reject All
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary" onclick="viewTeamCalendar()">
                        <i class="fas fa-calendar me-2"></i>Holiday Calendar
                    </button>
                    <button class="btn btn-outline-info" onclick="generateReport()">
                        <i class="fas fa-chart-bar me-2"></i>Team Reports
                    </button>
                    <button class="btn btn-outline-warning" onclick="viewMismatches()">
                        <i class="fas fa-exclamation-triangle me-2"></i>Review Mismatches
                    </button>
                    <a class="btn btn-outline-primary" href="/manager/mismatches/table">
                        <i class="fas fa-table me-2"></i>Mismatches Table
                    </a>
                    <small class="text-muted mt-1 d-block">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>AP</strong>=Present, <strong>AA</strong>=Absent in swipe data
                    </small>
                    <button class="btn btn-primary" onclick="viewAIInsights()">
                        <i class="fas fa-brain me-2"></i>AI Predictions
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Manager Profile -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Manager Info</h5>
            </div>
            <div class="card-body">
                <p><strong>Manager:</strong> {{ current_user.username }}</p>
                <p><strong>Email:</strong> {{ current_user.email }}</p>
                <p><strong>Role:</strong> {{ current_user.role.value.title() }}</p>
                <p><strong>Team Size:</strong> 8 members</p>
                <p><strong>Last Login:</strong> {{ current_user.last_login.strftime('%Y-%m-%d %H:%M') if current_user.last_login else 'First time' }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.table-warning {
    background-color: #fff3cd;
}
</style>

<!-- JavaScript for Manager Dashboard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Manager Dashboard loaded');
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function approveStatus(statusId) {
    console.log('Approving status ID:', statusId);
    
    if (confirm('Are you sure you want to approve this status?')) {
        fetch(`/manager/approve-status/${statusId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=approve'
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                alert('Status approved successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('Network error occurred: ' + error.message);
        });
    }
}

function rejectStatus(statusId) {
    console.log('Rejecting status ID:', statusId);
    
    const reason = prompt('Please provide a reason for rejection:');
    if (reason && reason.trim()) {
        console.log('Rejection reason:', reason);
        
        fetch(`/manager/approve-status/${statusId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=reject&reason=${encodeURIComponent(reason)}`
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                alert('Status rejected successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.error || data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('Network error occurred: ' + error.message);
        });
    }
}


function getSelectedPendingIds() {
    const checkboxes = Array.from(document.querySelectorAll('.pending-checkbox'));
    const selected = checkboxes.filter(cb => cb.checked).map(cb => parseInt(cb.value));
    // If none selected, default to all
    return selected.length ? selected : checkboxes.map(cb => parseInt(cb.value));
}

async function bulkAction(action, ids, reason) {
    try {
        const resp = await fetch('/manager/approve-status/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, status_ids: ids, reason: reason || '' })
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== 'success') {
            throw new Error(data.error || data.message || 'Bulk action failed');
        }
        alert(`${data.updated} status(es) ${action}d successfully`);
        location.reload();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function bulkApprove(statusIds) {
    const ids = statusIds && statusIds.length ? statusIds : getSelectedPendingIds();
    if (!ids.length) return alert('No pending statuses to approve');
    if (confirm('Approve ' + ids.length + ' status(es)?')) {
        bulkAction('approve', ids);
    }
}

function bulkReject(statusIds) {
    const ids = statusIds && statusIds.length ? statusIds : getSelectedPendingIds();
    if (!ids.length) return alert('No pending statuses to reject');
    const reason = prompt('Reason for rejection:');
    if (reason && reason.trim()) {
        bulkAction('reject', ids, reason.trim());
    }
}

function bulkApproveAll() {
    const ids = getSelectedPendingIds();
    if (!ids.length) return alert('No pending statuses to approve');
    if (confirm('Approve ' + ids.length + ' status(es)?')) {
        bulkAction('approve', ids);
    }
}

function bulkRejectAll() {
    const ids = getSelectedPendingIds();
    if (!ids.length) return alert('No pending statuses to reject');
    const reason = prompt('Reason for rejecting all pending statuses:');
    if (reason && reason.trim()) {
        bulkAction('reject', ids, reason.trim());
    }
}

function generateReport() {
    window.location.href = '/manager/reports';
}

function viewMismatches(vendorId) {
    // If vendorId provided, filter by that vendor
    if (vendorId) {
        window.location.href = '/manager/mismatches?vendor=' + vendorId;
    } else {
        window.location.href = '/manager/mismatches';
    }
}

function viewAIInsights() {
    window.location.href = '/manager/ai-insights';
}

function viewTeamCalendar() {
    window.location.href = '/holiday-calendar';
}

function viewDetails(vendorId) {
    console.log('Fetching details for vendor:', vendorId);
    
    // Show loading modal first
    showVendorSummaryModal('Loading...', null, true);
    
    // Fetch vendor summary data
    fetch(`/api/manager/vendor-summary/${vendorId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Replace the loading modal with content modal
                showVendorSummaryModal(vendorId, data.data, false);
            } else {
                // Close loading modal and show error
                closeVendorSummaryModal();
                alert('Error: ' + (data.error || data.message || 'Unable to fetch vendor details'));
            }
        })
        .catch(error => {
            console.error('Error fetching vendor details:', error);
            // Close loading modal and show error
            closeVendorSummaryModal();
            alert('Network error occurred while fetching vendor details');
        });
}


function refreshTeamStatus() {
    alert('Demo: Refreshing team status...\n\nIn production, this would:\n• Fetch latest status data\n• Update dashboard counts\n• Refresh team member table\n• Show loading indicators');
    location.reload();
}

function showVendorSummaryModal(vendorId, data, isLoading = false) {
    let modalHTML = '';
    
    if (isLoading) {
        modalHTML = `
        <div class="modal fade" id="vendorSummaryModal" tabindex="-1" aria-labelledby="vendorSummaryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="vendorSummaryModalLabel">
                            <i class="fas fa-user-circle me-2"></i>Loading Vendor Details...
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Fetching vendor information...</p>
                    </div>
                </div>
            </div>
        </div>`;
    } else {
        const vendor = data.vendor;
        const stats = data.statistics;
        const activities = data.recent_activities;
        const period = data.period;
        
        modalHTML = `
        <div class="modal fade" id="vendorSummaryModal" tabindex="-1" aria-labelledby="vendorSummaryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="vendorSummaryModalLabel">
                            <i class="fas fa-user-circle me-2"></i>${vendor.name} (${vendor.id})
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Vendor Info -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-id-card me-2"></i>Vendor Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Email:</strong> ${vendor.email}</p>
                                        <p><strong>Department:</strong> ${vendor.department}</p>
                                        <p><strong>Company:</strong> ${vendor.company}</p>
                                        <p><strong>Band:</strong> ${vendor.band}</p>
                                        <p><strong>Location:</strong> ${vendor.location}</p>
                                        <p><strong>Joined:</strong> ${vendor.created_at}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Summary Period</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Period:</strong> ${period.start_date} to ${period.end_date}</p>
                                        <p><strong>Working Days:</strong> ${stats.working_days}</p>
                                        <p><strong>Submissions:</strong> ${stats.total_submitted} / ${stats.working_days}</p>
                                        <p><strong>Submission Rate:</strong> <span class="badge bg-${stats.submission_rate >= 90 ? 'success' : stats.submission_rate >= 80 ? 'warning' : 'danger'}">${stats.submission_rate}%</span></p>
                                        <p><strong>Pending Approvals:</strong> ${stats.pending_approval}</p>
                                        <p><strong>Pending Mismatches:</strong> <span class="badge bg-${stats.pending_mismatches > 0 ? 'danger' : 'success'}">${stats.pending_mismatches}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-center bg-success text-white">
                                    <div class="card-body">
                                        <h3>${stats.total_office}</h3>
                                        <p class="mb-0">Office Days</p>
                                        <small>${stats.office_rate}% of submissions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center bg-info text-white">
                                    <div class="card-body">
                                        <h3>${stats.total_wfh}</h3>
                                        <p class="mb-0">WFH Days</p>
                                        <small>${stats.wfh_rate}% of submissions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-center bg-secondary text-white">
                                    <div class="card-body">
                                        <h3>${stats.total_leave}</h3>
                                        <p class="mb-0">Leave Days</p>
                                        <small>${stats.total_leave} total</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Working Hours Summary -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Working Hours Summary</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4 text-center">
                                                <div class="p-3 border rounded">
                                                    <h4 class="text-primary">${stats.total_working_hours || '0.0'}h</h4>
                                                    <small class="text-muted">Total Working Hours</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <div class="p-3 border rounded">
                                                    <h4 class="text-warning">${stats.total_extra_hours || '0.0'}h</h4>
                                                    <small class="text-muted">Extra Hours</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-center">
                                                <div class="p-3 border rounded">
                                                    <h4 class="text-info">${stats.average_hours_per_day || '0.0'}h</h4>
                                                    <small class="text-muted">Avg Hours/Day</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Breakdown -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Attendance Breakdown</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <p><strong>In Office - Full:</strong> ${stats.in_office_full}</p>
                                                <p><strong>In Office - Half:</strong> ${stats.in_office_half}</p>
                                                <p><strong>WFH - Full:</strong> ${stats.wfh_full}</p>
                                            </div>
                                            <div class="col-6">
                                                <p><strong>WFH - Half:</strong> ${stats.wfh_half}</p>
                                                <p><strong>Leave - Full:</strong> ${stats.leave_full}</p>
                                                <p><strong>Leave - Half:</strong> ${stats.leave_half}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Approval Status</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Approved:</strong> <span class="badge bg-success">${stats.approved}</span></p>
                                        <p><strong>Pending:</strong> <span class="badge bg-warning">${stats.pending_approval}</span></p>
                                        <p><strong>Rejected:</strong> <span class="badge bg-danger">${stats.rejected}</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activities -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activities (Last 10)</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Location</th>
                                                <th>Approval</th>
                                                <th>Submitted</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${activities && activities.length > 0 ? activities.map(activity => `
                                                <tr>
                                                    <td>${activity.date}</td>
                                                    <td><span class="badge bg-secondary">${activity.status}</span></td>
                                                    <td>${activity.location}</td>
                                                    <td><span class="badge bg-${activity.approval === 'Approved' ? 'success' : activity.approval === 'Pending' ? 'warning' : 'danger'}">${activity.approval}</span></td>
                                                    <td><small>${activity.submitted_at}</small></td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="5" class="text-center text-muted">No recent activities found</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="generateVendorReport('${vendor.id}')">
                            <i class="fas fa-download me-1"></i>Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    // Handle modal replacement properly
    const existingModal = document.getElementById('vendorSummaryModal');
    
    if (existingModal && !isLoading) {
        // If we're replacing with content modal, hide existing first
        try {
            const existingInstance = bootstrap.Modal.getInstance(existingModal);
            if (existingInstance) {
                existingInstance.hide();
            }
        } catch (e) { /* no-op */ }
        
        // Wait for hide animation, then replace
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            if (existingModal.parentNode) {
                existingModal.remove();
            }
            
            // Add new modal and show
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const newModalEl = document.getElementById('vendorSummaryModal');
            const modal = new bootstrap.Modal(newModalEl);
            modal.show();
        }, 150);
    } else {
        // For loading modal or first time, show immediately
        if (existingModal) {
            existingModal.remove();
        }
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const newModalEl = document.getElementById('vendorSummaryModal');
        const modal = new bootstrap.Modal(newModalEl);
        modal.show();
    }
}

function generateVendorReport(vendorId) {
    alert(`Generating report for vendor ${vendorId}...\n\nThis would export the vendor's detailed attendance report as Excel/PDF.`);
}

function closeVendorSummaryModal() {
    const existingModal = document.getElementById('vendorSummaryModal');
    if (existingModal) {
        try {
            const existingInstance = bootstrap.Modal.getInstance(existingModal);
            if (existingInstance) {
                existingInstance.hide();
            }
        } catch (e) { /* no-op */ }
        // Clean up any lingering backdrops
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            if (existingModal.parentNode) {
                existingModal.remove();
            }
        }, 300); // Wait for hide animation
    }
}
</script>

{% endblock %}
