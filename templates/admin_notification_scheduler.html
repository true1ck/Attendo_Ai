{% extends "base_fixed.html" %}

{% block title %}Notification Scheduler Control - Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-bell me-2"></i>Notification Scheduler Control</h2>
            <div>
                <a class="btn btn-secondary" href="{{ url_for('admin_dashboard') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>

            {% if not available %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> 
                <strong>Notification Scheduler Not Available</strong>
                <p class="mb-0">The enhanced notification scheduler service is not available. Please check the server logs.</p>
            </div>
            {% else %}
            
            <!-- Control Panel -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-gamepad"></i> Scheduler Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="btn-group" role="group">
                                <button id="btnStart" class="btn btn-success" onclick="controlScheduler('start')">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button id="btnStop" class="btn btn-danger" onclick="controlScheduler('stop')">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                                <button id="btnPause" class="btn btn-warning" onclick="controlScheduler('pause')">
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button id="btnResume" class="btn btn-info" onclick="controlScheduler('resume')">
                                    <i class="fas fa-play-circle"></i> Resume
                                </button>
                                <button id="btnForceSync" class="btn btn-primary" onclick="controlScheduler('force-sync')">
                                    <i class="fas fa-sync"></i> Force Sync Now
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-secondary" onclick="refreshStatus()">
                                <i class="fas fa-sync-alt"></i> Refresh Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Display -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Current Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <th width="40%">Status:</th>
                                    <td>
                                        <span id="statusBadge" class="badge">
                                            <span id="statusText">Loading...</span>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Last Run:</th>
                                    <td id="lastRun">-</td>
                                </tr>
                                <tr>
                                    <th>Next Run:</th>
                                    <td id="nextRun">-</td>
                                </tr>
                                <tr>
                                    <th>Total Processed:</th>
                                    <td id="totalProcessed">0</td>
                                </tr>
                                <tr>
                                    <th>Interval:</th>
                                    <td>Every 10 minutes</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-envelope"></i> Queue Statistics
                            </h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <th width="50%">Current Queue Size:</th>
                                    <td>
                                        <span class="badge bg-primary" id="queueSize">0</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Notifications Queued:</th>
                                    <td id="notificationsQueued">0</td>
                                </tr>
                                <tr>
                                    <th>Notifications Sent:</th>
                                    <td id="notificationsSent">0</td>
                                </tr>
                                <tr>
                                    <th>Network Sync:</th>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> G:\Test1\sent_noti_now.xlsx
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Types -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Notification Types & Schedule
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Schedule</th>
                                <th>Priority</th>
                                <th>Recipients</th>
                                <th>Max Daily</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="fas fa-clock text-primary"></i> Daily Status Reminders</td>
                                <td>9:00 AM, 12:00 PM, 3:00 PM, 6:00 PM</td>
                                <td><span class="badge bg-warning">Medium</span></td>
                                <td>Vendors</td>
                                <td>4</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-chart-bar text-info"></i> Manager Summary</td>
                                <td>12:00 PM, 2:00 PM</td>
                                <td><span class="badge bg-warning">Medium</span></td>
                                <td>Managers</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-exclamation-triangle text-danger"></i> Mismatch Alerts</td>
                                <td>6:00 PM Daily</td>
                                <td><span class="badge bg-danger">High</span></td>
                                <td>Vendors, Managers</td>
                                <td>1</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-check-circle text-success"></i> All-Complete</td>
                                <td>Event-driven</td>
                                <td><span class="badge bg-secondary">Low</span></td>
                                <td>Managers</td>
                                <td>1</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-comments text-primary"></i> Manager Feedback</td>
                                <td>Event-driven</td>
                                <td><span class="badge bg-warning">Medium</span></td>
                                <td>Vendors</td>
                                <td>5</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-file-alt text-info"></i> Monthly Reports</td>
                                <td>1st of month at 9:00 AM</td>
                                <td><span class="badge bg-warning">Medium</span></td>
                                <td>Managers, Admins</td>
                                <td>1</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-server text-danger"></i> System Alerts</td>
                                <td>Event-driven</td>
                                <td><span class="badge bg-danger text-white">Critical</span></td>
                                <td>Admins</td>
                                <td>10</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-umbrella-beach text-success"></i> Holiday Reminders</td>
                                <td>3 days & 1 day before</td>
                                <td><span class="badge bg-secondary">Low</span></td>
                                <td>All Users</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-clock text-danger"></i> Late Submission</td>
                                <td>24h & 48h after deadline</td>
                                <td><span class="badge bg-danger">High</span></td>
                                <td>Managers, Admins</td>
                                <td>2</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Error Log -->
            <div class="card mt-4" id="errorCard" style="display: none;">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Recent Errors
                    </h5>
                </div>
                <div class="card-body">
                    <div id="errorList" class="small">
                        <!-- Errors will be populated here -->
                    </div>
                </div>
            </div>

        {% endif %}
    </div>
</div>

<script>
{% if available %}
let refreshInterval;

function controlScheduler(action) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    button.disabled = true;

    fetch(`/api/notification-scheduler/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(refreshStatus, 1000);
        } else {
            showAlert('danger', data.message || 'Operation failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Failed to perform operation');
    })
    .finally(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

function refreshStatus() {
    fetch('/api/notification-scheduler/status')
    .then(response => response.json())
    .then(data => {
        if (data.available && data.status) {
            updateStatusDisplay(data.status);
        }
    })
    .catch(error => {
        console.error('Error fetching status:', error);
    });
}

function updateStatusDisplay(status) {
    // Update status badge
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    
    if (status.running) {
        if (status.paused) {
            statusBadge.className = 'badge bg-warning';
            statusText.textContent = 'Paused';
        } else {
            statusBadge.className = 'badge bg-success';
            statusText.textContent = 'Running';
        }
    } else {
        statusBadge.className = 'badge bg-danger';
        statusText.textContent = 'Stopped';
    }
    
    // Update times
    if (status.last_run) {
        const lastRun = new Date(status.last_run);
        document.getElementById('lastRun').textContent = lastRun.toLocaleString();
    } else {
        document.getElementById('lastRun').textContent = '-';
    }
    
    if (status.next_run && status.running && !status.paused) {
        const nextRun = new Date(status.next_run);
        document.getElementById('nextRun').textContent = nextRun.toLocaleString();
    } else {
        document.getElementById('nextRun').textContent = status.running ? (status.paused ? 'Paused' : '-') : 'Not scheduled';
    }
    
    // Update statistics
    document.getElementById('totalProcessed').textContent = status.total_processed || 0;
    document.getElementById('queueSize').textContent = status.current_queue_size || 0;
    document.getElementById('notificationsQueued').textContent = status.notifications_queued || 0;
    document.getElementById('notificationsSent').textContent = status.notifications_sent || 0;
    
    // Update errors if any
    if (status.errors && status.errors.length > 0) {
        document.getElementById('errorCard').style.display = 'block';
        const errorList = document.getElementById('errorList');
        errorList.innerHTML = '';
        
        status.errors.forEach(error => {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mb-2';
            if (typeof error === 'object') {
                errorDiv.innerHTML = `<strong>${new Date(error.time).toLocaleString()}:</strong> ${error.error}`;
            } else {
                errorDiv.textContent = error;
            }
            errorList.appendChild(errorDiv);
        });
    } else {
        document.getElementById('errorCard').style.display = 'none';
    }
    
    // Update button states
    updateButtonStates(status);
}

function updateButtonStates(status) {
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnPause = document.getElementById('btnPause');
    const btnResume = document.getElementById('btnResume');
    
    if (status.running) {
        btnStart.disabled = true;
        btnStop.disabled = false;
        
        if (status.paused) {
            btnPause.disabled = true;
            btnResume.disabled = false;
        } else {
            btnPause.disabled = false;
            btnResume.disabled = true;
        }
    } else {
        btnStart.disabled = false;
        btnStop.disabled = true;
        btnPause.disabled = true;
        btnResume.disabled = true;
    }
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();
    
    // Auto-refresh every 30 seconds
    refreshInterval = setInterval(refreshStatus, 30000);
});

// Clean up interval on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
{% endif %}
</script>
{% endblock %}
