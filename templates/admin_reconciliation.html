{% extends "base_fixed.html" %}
{% block title %}Reconciliation Report{% endblock %}
{% block content %}
<!-- Swipe Status Code Legend -->
<div class="card mb-3">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Swipe Data Status Codes</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-success me-3 px-3 py-2">AP</span>
          <div>
            <strong>Attendance Present</strong><br>
            <small class="text-muted">Employee physically swiped in/out of office. Card reader detected presence.</small>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="d-flex align-items-center mb-2">
          <span class="badge bg-danger me-3 px-3 py-2">AA</span>
          <div>
            <strong>Attendance Absent</strong><br>
            <small class="text-muted">No swipe detected. Employee did not physically enter office.</small>
          </div>
        </div>
      </div>
    </div>
    <div class="alert alert-info mb-0 mt-3">
      <i class="fas fa-lightbulb me-2"></i>
      <strong>How Mismatches Work:</strong> System compares employee-submitted status vs actual swipe data to catch conflicts.
      <br><strong>Example:</strong> Employee claims "WFH" but swipe shows "AP" = Mismatch (they were actually in office)
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Reconciliation Summary</h5>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-warning" onclick="runReconciliationNow()"><i class="fas fa-cogs me-1"></i>Run Reconciliation</button>
    </div>
  </div>
  <div class="card-body">
    <div class="row text-center">
      <div class="col-md-3"><div class="p-2 bg-light rounded"><div class="fw-bold">Total</div><div class="fs-4">{{ summary.total }}</div></div></div>
      <div class="col-md-3"><div class="p-2 bg-warning-subtle rounded"><div class="fw-bold">Pending</div><div class="fs-4">{{ summary.pending }}</div></div></div>
      <div class="col-md-3"><div class="p-2 bg-success-subtle rounded"><div class="fw-bold">Approved</div><div class="fs-4">{{ summary.approved }}</div></div></div>
      <div class="col-md-3"><div class="p-2 bg-danger-subtle rounded"><div class="fw-bold">Rejected</div><div class="fs-4">{{ summary.rejected }}</div></div></div>
    </div>
  </div>
</div>
<script>
function runReconciliationNow(){
  if(!confirm('Run reconciliation for all vendors?')) return;
  fetch('/import/reconcile', { method: 'POST' })
    .then(r => r.json()).then(d => {
      if(d.success){ alert(d.message); location.reload(); }
      else { alert('Reconciliation error: '+(d.message||'Unknown error')); }
    })
    .catch(e => alert('Reconciliation failed: '+e.message));
}
</script>

<div class="card">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <span><i class="fas fa-list me-2"></i>Mismatches (Latest)</span>
      <small class="text-muted">Hover over swipe codes for details</small>
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-striped">
        <thead><tr>
          <th>Date</th>
          <th>Vendor</th>
          <th>Employee Status</th>
          <th>Swipe Data</th>
          <th>Conflict</th>
          <th>Manager Review</th>
          <th>Details</th>
        </tr></thead>
        <tbody>
          {% for m in mismatches %}
          <tr>
            <td>{{ m.mismatch_date.strftime('%Y-%m-%d') }}</td>
            <td>
              <strong>{{ m.vendor.full_name if m.vendor else '-' }}</strong><br>
              <small class="text-muted">({{ m.vendor.vendor_id if m.vendor else '' }})</small>
            </td>
            <td>
              {% if m.web_status %}
                <span class="badge bg-primary">{{ m.web_status.value.replace('_', ' ').title() }}</span>
              {% else %}
                <span class="badge bg-secondary">Not Submitted</span>
              {% endif %}
            </td>
            <td>
              {% if m.swipe_status == 'AP' %}
                <span class="badge bg-success" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="top" 
                      title="Attendance Present - Employee physically swiped into office">
                  AP <i class="fas fa-building ms-1"></i>
                </span>
              {% elif m.swipe_status == 'AA' %}
                <span class="badge bg-danger" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="top" 
                      title="Attendance Absent - No swipe detected, employee not in office">
                  AA <i class="fas fa-times ms-1"></i>
                </span>
              {% else %}
                <span class="badge bg-secondary">{{ m.swipe_status or 'Unknown' }}</span>
              {% endif %}
            </td>
            <td>
              {% if m.web_status and m.swipe_status %}
                {% if (m.web_status.value in ['wfh_full', 'wfh_half', 'leave_full', 'leave_half'] and m.swipe_status == 'AP') %}
                  <span class="text-danger"><i class="fas fa-exclamation-triangle"></i> High</span><br>
                  <small class="text-muted">Claimed {{ m.web_status.value.split('_')[0].upper() }} but was in office</small>
                {% elif (m.web_status.value in ['in_office_full', 'in_office_half'] and m.swipe_status == 'AA') %}
                  <span class="text-warning"><i class="fas fa-question-circle"></i> Medium</span><br>
                  <small class="text-muted">Claimed office but no swipe detected</small>
                {% else %}
                  <span class="text-info"><i class="fas fa-info-circle"></i> Low</span><br>
                  <small class="text-muted">Approval or record issue</small>
                {% endif %}
              {% else %}
                <span class="text-secondary">-</span>
              {% endif %}
            </td>
            <td>
              {% if m.manager_approval %}
                {% if m.manager_approval.value == 'approved' %}
                  <span class="badge bg-success">Approved</span>
                {% elif m.manager_approval.value == 'rejected' %}
                  <span class="badge bg-danger">Rejected</span>
                {% else %}
                  <span class="badge bg-warning">Pending</span>
                {% endif %}
              {% else %}
                <span class="badge bg-warning">Pending</span>
              {% endif %}
            </td>
            <td>
              {% set details = m.get_mismatch_details() %}
              {% if details and details.get('full_day_mismatch') %}
                <small class="text-muted">{{ details['full_day_mismatch'].get('recommendation', m.manager_comments or '-')[:50] }}{% if (details['full_day_mismatch'].get('recommendation', m.manager_comments or '-')|length) > 50 %}...{% endif %}</small>
              {% else %}
                <small class="text-muted">{{ m.manager_comments or '-' }}</small>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Initialize Bootstrap tooltips -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
{% endblock %}

