{% extends "base_fixed.html" %}

{% block title %}AI Insights & Predictions - VendorTime{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="mb-4">
            <h2><i class="fas fa-brain me-2 text-primary"></i>AI Insights & Predictions</h2>
        </div>
    </div>
</div>

<!-- AI Model Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success d-flex align-items-center">
            <i class="fas fa-check-circle me-3 fa-2x"></i>
            <div>
                <h5 class="mb-1">AI Model Status: Active & Learning</h5>
                <small>Last trained: {{ ai_stats.last_trained or 'Today, 09:30 AM' }} | 
                Accuracy: {{ ai_stats.accuracy or '94.2%' }} | 
                Predictions Made: {{ ai_stats.predictions_made or '1,247' }}</small>
            </div>
        </div>
    </div>
</div>

<!-- AI Predictions Dashboard -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-gradient-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Absence Predictions</h6>
                        <h4 class="mb-0">{{ ai_stats.absence_predictions or 8 }}</h4>
                        <small>Next 7 days</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-gradient-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">WFH Predictions</h6>
                        <h4 class="mb-0">{{ ai_stats.wfh_predictions or 12 }}</h4>
                        <small>Likely requests</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-home fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-gradient-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Risk Alerts</h6>
                        <h4 class="mb-0">{{ ai_stats.risk_alerts or 3 }}</h4>
                        <small>High absence risk</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-gradient-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Pattern Insights</h6>
                        <h4 class="mb-0">{{ ai_stats.pattern_insights or 15 }}</h4>
                        <small>New patterns found</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main AI Insights Content -->
<div class="row">
    <div class="col-md-8">
        <!-- Absence Prediction Results -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-crystal-ball me-2 text-primary"></i>Absence Predictions - Next 7 Days</h5>
                <div>
                    <span class="badge bg-success">94.2% Accurate</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPredictions()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Predicted Date</th>
                                <th>Likelihood</th>
                                <th>Reason</th>
                                <th>Recommendation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if predictions and predictions|length > 0 %}
                                {% for p in predictions %}
                                <tr class="{% if p.risk_level == 'Critical' %}table-danger{% elif p.risk_level == 'High' %}table-warning{% endif %}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-{% if p.risk_level == 'Critical' %}danger{% elif p.risk_level == 'High' %}warning{% elif p.risk_level == 'Medium' %}info{% else %}success{% endif %} me-2">
                                                {{ p.vendor_id[:2] if p.vendor_id else 'V' }}
                                            </div>
                                            <strong>{{ p.vendor_name }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ p.predicted_date_display }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-{% if p.risk_level == 'Critical' %}danger{% elif p.risk_level == 'High' %}warning{% elif p.risk_level == 'Medium' %}info{% else %}success{% endif %}" style="width: {{ p.likelihood }}%">{{ p.likelihood }}%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>
                                            {% for r in p.reasons %}
                                                - {{ r }}{% if not loop.last %}<br>{% endif %}
                                            {% endfor %}
                                        </small>
                                    </td>
                                    <td>
                                        {% set rec = p.recommendation %}
                                        <span class="badge bg-{% if rec == 'Urgent Intervention' %}danger{% elif rec == 'Proactive Check-in' %}info{% else %}success{% endif %}">{{ rec }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-{% if p.risk_level in ['High','Critical'] %}danger{% else %}warning{% endif %}" onclick="contactVendor('{{ p.vendor_id }}')">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('{{ p.vendor_id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr class="table-warning">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-warning me-2">V1</div>
                                            <strong>vendor1</strong>
                                        </div>
                                    </td>
                                    <td>Sep 09, 2025</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-warning" style="width: 87%">87%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>Historical pattern:<br>
                                        - Usually takes leave on Mondays<br>
                                        - Recent stress indicators</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">Proactive Check-in</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="contactVendor('vendor1')">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('vendor1')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr class="table-danger">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-danger me-2">V5</div>
                                            <strong>vendor5</strong>
                                        </div>
                                    </td>
                                    <td>Sep 08, 2025</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-danger" style="width: 92%">92%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>High risk factors:<br>
                                        - Erratic attendance pattern<br>
                                        - Multiple late submissions</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">Urgent Intervention</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="contactVendor('vendor5')">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('vendor5')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-info me-2">V3</div>
                                            <strong>vendor3</strong>
                                        </div>
                                    </td>
                                    <td>Sep 10, 2025</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-info" style="width: 76%">76%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>Pattern indicators:<br>
                                        - Friday absence trend<br>
                                        - Personal commitments</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">Schedule Backup</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="contactVendor('vendor3')">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('vendor3')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Team Performance Dashboard -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users me-2 text-primary"></i>Team Performance Overview</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <canvas id="attendanceChart" width="300" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <canvas id="predictionChart" width="300" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <canvas id="weeklyTrendChart" width="300" height="200"></canvas>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <canvas id="teamProductivityChart" width="400" height="250"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="absencePatternChart" width="400" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Manager Action Insights -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2 text-warning"></i>Actionable Manager Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="insight-card border rounded p-3 mb-3 bg-light">
                            <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Critical Actions Needed</h6>
                            <ul class="small mb-2">
                                <li><strong>Vendor5:</strong> 92% likely absent tomorrow - Schedule immediate 1:1</li>
                                <li><strong>Vendor1:</strong> Monday pattern detected - Consider flexible arrangement</li>
                                <li><strong>Team capacity:</strong> 15% reduction expected this week</li>
                            </ul>
                            <button class="btn btn-sm btn-danger" onclick="showCriticalActions()">
                                <i class="fas fa-tasks me-1"></i>View Action Plan
                            </button>
                        </div>
                        
                        <div class="insight-card border rounded p-3 mb-3">
                            <h6 class="text-info"><i class="fas fa-chart-bar me-2"></i>Team Productivity Insights</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <strong class="text-success">87%</strong><br>
                                    <small>Avg Attendance</small>
                                </div>
                                <div class="col-4">
                                    <strong class="text-warning">2.3 days</strong><br>
                                    <small>Avg WFH/week</small>
                                </div>
                                <div class="col-4">
                                    <strong class="text-info">94%</strong><br>
                                    <small>On-time Submissions</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="insight-card border rounded p-3 mb-3">
                            <h6 class="text-success"><i class="fas fa-thumbs-up me-2"></i>Team Strengths</h6>
                            <ul class="small mb-2">
                                <li><strong>Vendor2, Vendor4:</strong> 100% reliability score - Great role models</li>
                                <li><strong>Mid-week performance:</strong> Tue-Thu shows 95% consistency</li>
                                <li><strong>Communication:</strong> 89% proactive status updates</li>
                            </ul>
                        </div>
                        
                        <div class="insight-card border rounded p-3 mb-3 bg-light">
                            <h6 class="text-primary"><i class="fas fa-calendar-alt me-2"></i>Weekly Planning Recommendations</h6>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Mon:</strong> <span class="badge bg-warning">High Risk</span><br>
                                    <small>Schedule important meetings Tue-Thu</small>
                                </div>
                                <div class="col-6">
                                    <strong>Fri:</strong> <span class="badge bg-info">WFH Peak</span><br>
                                    <small>Expect 40% remote work requests</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Manager Tips for This Week</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Monday Focus:</strong> Check in with high-risk team members early morning
                                </div>
                                <div class="col-md-4">
                                    <strong>Resource Planning:</strong> Have backup coverage for predicted absences
                                </div>
                                <div class="col-md-4">
                                    <strong>Team Morale:</strong> Recognize consistent performers publicly
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediction Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-primary"></i>Prediction Summary</h5>
            </div>
            <div class="card-body">
                <p class="small mb-3">
                    This page shows heuristic AI predictions for your team over the next few days. Each row in the table is a vendor with a predicted absence date, a likelihood percentage, a risk level, and recommended action.
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-2">How to interpret</h6>
                        <ul class="small mb-3">
                            <li><strong>Likelihood %</strong>: Confidence (0–100) that the event will happen on the predicted date.</li>
                            <li><strong>Risk level</strong>: Critical/High/Medium/Low based on likelihood and business impact.</li>
                            <li><strong>Reasons</strong>: Top drivers such as weekday patterns, recent approvals, workload, or seasonality.</li>
                            <li><strong>Recommendation</strong>: Immediate next step (e.g., Proactive Check-in or Urgent Intervention).</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-2">What the charts mean</h6>
                        <ul class="small mb-3">
                            <li><strong>Attendance vs Predictions</strong>: Compares historical actuals with predicted trend lines.</li>
                            <li><strong>Risk Distribution</strong>: Share of vendors by risk tier for your current prediction window.</li>
                        </ul>
                        <div class="alert alert-secondary small mb-0">
                            Tips: Focus on Critical/High items first. Use Quick Actions to export a report, schedule daily analysis, view logs, or temporarily disable AI if needed.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Configuration & Tools -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>AI Configuration</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    <label class="form-label small">Prediction Sensitivity</label>
                    <input type="range" class="form-range" id="sensitivity" min="50" max="95" value="87" oninput="updateSensitivity(this.value)">
                    <small class="text-muted">Current: <span id="sensitivityValue">87%</span></small>
                </div>
                
                <div class="form-group mb-3">
                    <label class="form-label small">Prediction Window</label>
                    <select class="form-control form-control-sm" id="predictionWindow" onchange="updatePredictionWindow()">
                        <option value="3">3 days</option>
                        <option value="7" selected>7 days</option>
                        <option value="14">14 days</option>
                        <option value="30">30 days</option>
                    </select>
                </div>
                
                <div class="form-group mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoIntervention" checked>
                        <label class="form-check-label small" for="autoIntervention">
                            Auto-interventions
                        </label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="realTimeUpdates" checked>
                        <label class="form-check-label small" for="realTimeUpdates">
                            Real-time updates
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="applyAISettings()">
                    <i class="fas fa-save me-1"></i>Apply Settings
                </button>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetAISettings()">
                    <i class="fas fa-undo me-1"></i>Reset to Default
                </button>
            </div>
        </div>
        
        <!-- Model Performance -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Model Performance</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <small>Accuracy</small>
                    <strong>94.2%</strong>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: 94.2%"></div>
                </div>
                
                <div class="d-flex justify-content-between mb-2">
                    <small>Precision</small>
                    <strong>91.8%</strong>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-info" style="width: 91.8%"></div>
                </div>
                
                <div class="d-flex justify-content-between mb-2">
                    <small>Recall</small>
                    <strong>89.3%</strong>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: 89.3%"></div>
                </div>
                
                <small class="text-muted">Last evaluated: 2 hours ago</small>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="generateAIReport()">
                        <i class="fas fa-file-alt me-2"></i>Generate AI Report
                    </button>
                    <button class="btn btn-info" onclick="scheduleAIAnalysis()">
                        <i class="fas fa-calendar me-2"></i>Schedule Analysis
                    </button>
                    <button class="btn btn-warning" onclick="viewModelLogs()">
                        <i class="fas fa-history me-2"></i>Model Training Logs
                    </button>
                    <button class="btn btn-danger" onclick="emergencyOverride()">
                        <i class="fas fa-exclamation-circle me-2"></i>Emergency Override
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34);
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #e0a800);
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #138496);
}

.avatar-circle {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
}

.recommendation-item {
    padding: 12px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.insight-card {
    transition: all 0.3s ease;
}

.insight-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.insight-card h6 {
    margin-bottom: 8px;
    font-weight: 600;
}

.progress {
    border-radius: 10px;
}

.form-range {
    height: 20px;
}
</style>

<!-- JavaScript for AI Insights -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Risk distribution from server (fallback zeros if not provided)
var riskDist = {{ (risk_distribution or {'low':0,'medium':0,'high':0,'critical':0}) | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    console.log('AI Insights Dashboard loaded');
    initializeCharts();
});

function initializeCharts() {
    // Attendance Trend Chart
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(attendanceCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            datasets: [{
                label: 'Actual',
                data: [82, 95, 94, 96, 88, 45],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'Predicted',
                data: [85, 93, 95, 94, 86, 42],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderDash: [5, 5],
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Attendance %',
                    font: { size: 12 }
                },
                legend: {
                    position: 'bottom',
                    labels: { font: { size: 10 } }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { font: { size: 10 } }
                },
                x: { ticks: { font: { size: 10 } } }
            }
        }
    });
    
    // Weekly Trend Chart
    const weeklyCtx = document.getElementById('weeklyTrendChart').getContext('2d');
    new Chart(weeklyCtx, {
        type: 'bar',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Office',
                data: [65, 70, 68, 72],
                backgroundColor: '#28a745',
            }, {
                label: 'WFH',
                data: [25, 22, 27, 23],
                backgroundColor: '#17a2b8',
            }, {
                label: 'Leave',
                data: [10, 8, 5, 5],
                backgroundColor: '#ffc107',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Monthly Breakdown',
                    font: { size: 12 }
                },
                legend: {
                    position: 'bottom',
                    labels: { font: { size: 10 } }
                }
            },
            scales: {
                x: { stacked: true, ticks: { font: { size: 10 } } },
                y: { stacked: true, ticks: { font: { size: 10 } } }
            }
        }
    });
    
    // Team Productivity Chart
    const productivityCtx = document.getElementById('teamProductivityChart').getContext('2d');
    new Chart(productivityCtx, {
        type: 'radar',
        data: {
            labels: ['Consistency', 'Punctuality', 'Communication', 'Flexibility', 'Reliability', 'Proactiveness'],
            datasets: [{
                label: 'Team Average',
                data: [87, 92, 89, 78, 94, 85],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderWidth: 2
            }, {
                label: 'Top Performer',
                data: [95, 98, 95, 90, 100, 96],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Team Performance Metrics'
                },
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Absence Pattern Chart
    const absenceCtx = document.getElementById('absencePatternChart').getContext('2d');
    new Chart(absenceCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Planned Leave',
                data: [8, 6, 12, 15, 10, 7],
                backgroundColor: '#28a745',
            }, {
                label: 'Sick Leave',
                data: [5, 8, 4, 3, 6, 4],
                backgroundColor: '#dc3545',
            }, {
                label: 'Unplanned',
                data: [3, 5, 2, 1, 2, 3],
                backgroundColor: '#ffc107',
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Absence Patterns (6 Months)'
                },
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Days'
                    }
                }
            }
        }
    });

    // Risk Prediction Chart
    const predictionCtx = document.getElementById('predictionChart').getContext('2d');
    new Chart(predictionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical'],
            datasets: [{
                data: [riskDist.low, riskDist.medium, riskDist.high, riskDist.critical],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#fd7e14',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Risk Distribution'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function trainModel() {
    if (confirm('Re-train AI model with latest data? This process takes 5-10 minutes.')) {
        alert('AI model training started!\\n\\nTraining will run in background:\\n- Using last 6 months of data\\n- Incorporating latest patterns\\n- Improving prediction accuracy\\n\\nYou will be notified when complete.');
    }
}

function exportInsights() {
    alert('Exporting AI Insights\\n\\nGenerating comprehensive report with:\\n- Prediction results\\n- Model performance metrics\\n- Recommendation summary\\n- Historical accuracy data');
}

function refreshPredictions() {
    alert('Refreshing predictions with latest data...');
    setTimeout(() => {
        alert('Predictions updated! Found 2 new high-risk cases.');
    }, 1500);
}

function contactVendor(vendorId) {
    alert(`Contacting ${vendorId}\\n\\nInitiating proactive outreach:\\n- Sending wellness check message\\n- Scheduling optional 1:1\\n- Providing support resources`);
}

function viewDetails(vendorId) {
    alert(`Detailed AI Analysis for ${vendorId}:\\n\\nRisk Factors:\\n• Historical Monday absences: 4 of last 6\\n• Recent stress indicators detected\\n• Project deadline alignment\\n\\nRecommendations:\\n• Flexible work arrangement\\n• Regular check-ins\\n• Workload adjustment`);
}

function implementRecommendation(type) {
    const recommendations = {
        'resource': 'Resource allocation optimized for predicted absences',
        'communication': 'Proactive communication schedule created',
        'policy': 'Flexible work policy proposal generated',
        'automation': 'Smart reminder system activated'
    };
    
    alert(`Implementing: ${recommendations[type]}\\n\\nAction items created and assigned to relevant managers.`);
}

function updateSensitivity(value) {
    document.getElementById('sensitivityValue').textContent = value + '%';
}

function updatePredictionWindow() {
    const window = document.getElementById('predictionWindow').value;
    alert(`Prediction window updated to ${window} days. Recalculating predictions...`);
}

function applyAISettings() {
    alert('AI Settings Applied Successfully!\\n\\nNew configuration active:\\n- Updated prediction sensitivity\\n- Modified intervention rules\\n- Real-time processing enabled');
}

function resetAISettings() {
    if (confirm('Reset AI settings to default values?')) {
        document.getElementById('sensitivity').value = 87;
        document.getElementById('sensitivityValue').textContent = '87%';
        document.getElementById('predictionWindow').value = 7;
        document.getElementById('autoIntervention').checked = true;
        document.getElementById('realTimeUpdates').checked = true;
        alert('AI settings reset to default values.');
    }
}

function generateAIReport() {
    const params = new URLSearchParams({ window: '7', format: 'excel' });
    window.open('/api/ai/report?' + params.toString(), '_blank');
}

async function scheduleAIAnalysis() {
    try {
        const res = await fetch('/api/ai/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ schedule: 'daily' })
        });
        const data = await res.json();
        if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to schedule');
        alert(data.message || 'Scheduled successfully');
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function viewModelLogs() {
    try {
        const res = await fetch('/api/ai/model-logs');
        const data = await res.json();
        if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to fetch logs');
        const lines = (data.logs || []).map(l => `${l.timestamp} - ${l.action} (${l.table})`).slice(0, 10);
        alert('Recent AI Logs\n\n' + (lines.join('\n') || 'No logs available'));
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function emergencyOverride() {
    if (confirm('Emergency Override will disable AI predictions temporarily. Continue?')) {
        try {
            const res = await fetch('/api/ai/override', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enable: false }) });
            const data = await res.json();
            if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to override');
            alert('AI predictions temporarily disabled. System switched to manual mode.');
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }
}

function showCriticalActions() {
    const actionPlan = `Critical Action Plan for This Week:

` +
        `🔴 IMMEDIATE (Today):
` +
        `• Contact Vendor5 - 92% absence probability tomorrow
` +
        `• Prepare backup coverage for critical tasks
` +
        `• Review project deadlines for impact assessment

` +
        `🟡 THIS WEEK:
` +
        `• Schedule 1:1 with Vendor1 about Monday patterns
` +
        `• Arrange flexible work options for high-risk team members
` +
        `• Redistribute workload to minimize disruption

` +
        `📊 MONITORING:
` +
        `• Daily check-ins with predicted high-risk members
` +
        `• Track team capacity (currently 85% this week)
` +
        `• Monitor stress indicators and workload balance`;
    
    alert(actionPlan);
}
</script>
{% endblock %}
