{% extends "base_fixed.html" %}

{% block title %}Excel Sync Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">üìä Excel Sync Administration</h1>
            <p class="text-muted">Monitor and control Excel notification files synchronization</p>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">‚öôÔ∏è Sync Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Local Folder:</strong><br>
                            <code>{{ local_folder }}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Network Folder:</strong><br>
                            <code>{{ network_folder or 'Not configured' }}</code>
                        </div>
                    </div>
                    
                    {% if not network_folder %}
                    <hr>
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Network folder not configured!</strong> 
                        Please set your network drive path below to enable synchronization.
                    </div>
                    {% endif %}
                    
                    <hr>
                    <div class="form-group">
                        <label for="networkFolder"><strong>Set Network Folder Path:</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="networkFolder" 
                                   placeholder="Enter network drive path (e.g., Z:\path\to\notification_configs)"
                                   value="{{ network_folder or '' }}">
                            <div class="input-group-append">
                                <button class="btn btn-primary" onclick="configureNetworkFolder()">
                                    üíæ Save Path
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            This is where your Excel files will be copied for Power Automate to access.
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üö¶ Service Status</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <span class="status-indicator 
                            {% if sync_running and not sync_paused %}bg-success
                            {% elif sync_paused %}bg-warning
                            {% else %}bg-danger{% endif %}"></span>
                        <strong class="ml-2">
                            {% if sync_running and not sync_paused %}Running
                            {% elif sync_paused %}Paused
                            {% else %}Stopped{% endif %}
                        </strong>
                    </div>
                    
                    <p class="mb-2">
                        <strong>Last Sync:</strong><br>
                        <small>{{ sync_status.last_sync or 'Never' }}</small>
                    </p>
                    
                    <p class="mb-2">
                        <strong>Files Synced:</strong> {{ sync_status.files_synced }}
                    </p>
                    
                    <p class="mb-0">
                        <strong>Errors:</strong> 
                        <span class="{% if sync_status.errors %}text-danger{% else %}text-success{% endif %}">
                            {{ sync_status.errors|length }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üéõÔ∏è Sync Controls</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group mr-2" role="group">
                        <button type="button" class="btn btn-success" onclick="controlSync('start')">
                            ‚ñ∂Ô∏è Start Service
                        </button>
                        <button type="button" class="btn btn-danger" onclick="controlSync('stop')">
                            ‚èπÔ∏è Stop Service
                        </button>
                    </div>
                    
                    <div class="btn-group mr-2" role="group">
                        <button type="button" class="btn btn-warning" onclick="controlSync('pause')">
                            ‚è∏Ô∏è Pause
                        </button>
                        <button type="button" class="btn btn-info" onclick="controlSync('resume')">
                            ‚ñ∂Ô∏è Resume
                        </button>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="forceSync()">
                        üîÑ Force Sync Now
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="refreshStatus()">
                        üîÑ Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Control Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">üõë Stop Notifications Control</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadNotificationFiles()">
                        üîÑ Refresh Files
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Use these controls to stop individual notifications by clearing their data from the network drive Excel files.
                        This will preserve the table structure but remove all notification data rows.
                    </p>
                    
                    <div class="alert alert-info alert-sm mb-3" style="font-size: 0.9em;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Excel temporary lock files (~$*.xlsx) are automatically filtered out and won't appear below.
                        These files are created when Excel has the notification files open and are not the actual notification files.
                    </div>
                    
                    <div id="notification-files-container">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <span class="ml-2">Loading notification files...</span>
                        </div>
                    </div>
                    
                    <hr class="mt-4">
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="button" class="btn btn-danger" onclick="clearAllNotifications()">
                                üö´ Stop All Notifications
                            </button>
                            <small class="text-muted ml-2">
                                This will clear data from all notification files
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Log -->
    {% if sync_status.errors %}
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">üìã Recent Errors</h5>
                </div>
                <div class="card-body">
                    <div class="excel-sync-errors" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        {% for error in sync_status.errors[-10:] %}
                            <div class="text-danger mb-1">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}
</style>

<script>
function controlSync(action) {
    fetch(`/api/excel-sync/control/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
        }
        setTimeout(() => location.reload(), 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error);
    });
}

function forceSync() {
    fetch('/api/excel-sync/force', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        setTimeout(() => location.reload(), 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error);
    });
}

function configureNetworkFolder() {
    const networkFolder = document.getElementById('networkFolder').value.trim();
    
    if (!networkFolder) {
        alert('Please enter a network folder path');
        return;
    }
    
    fetch('/api/excel-sync/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            network_folder: networkFolder
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message);
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error);
    });
}

function refreshStatus() {
    location.reload();
}

// Load notification files and display controls
function loadNotificationFiles() {
    const container = document.getElementById('notification-files-container');
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <span class="ml-2">Loading notification files...</span>
        </div>
    `;
    
    fetch('/api/excel-sync/list-files', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('API Response Status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response Data:', data);
        if (data.success && data.files && data.files.length > 0) {
            // Display files with controls
            let html = '<div class="row">';
            
            data.files.forEach(file => {
                const dataRowsText = typeof file.data_rows === 'number' 
                    ? `${file.data_rows} data rows` 
                    : 'Error reading file';
                    
                const buttonDisabled = file.data_rows === 0 || file.data_rows === 'Error' 
                    ? 'disabled' 
                    : '';
                    
                const buttonClass = file.data_rows === 0 
                    ? 'btn-secondary' 
                    : 'btn-warning';
                    
                const statusBadge = file.data_rows === 0 
                    ? '<span class="badge badge-success">No Data</span>' 
                    : file.data_rows === 'Error'
                        ? '<span class="badge badge-danger">Error</span>'
                        : `<span class="badge badge-info">${dataRowsText}</span>`;
                
                const buttonText = file.data_rows === 0 
                    ? '‚úÖ No Notifications' 
                    : 'üõë Stop Notifications';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border">
                            <div class="card-body">
                                <h6 class="card-title">${file.display_name}</h6>
                                <p class="card-text text-muted small mb-2">
                                    <strong>File:</strong> ${file.name}<br>
                                    <strong>Modified:</strong> ${file.modified}<br>
                                    <strong>Status:</strong> ${statusBadge}
                                </p>
                                <button class="btn btn-sm ${buttonClass} ${buttonDisabled}" 
                                        onclick="clearNotificationFile('${file.name}', '${file.display_name}')" 
                                        ${buttonDisabled}>
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            const warningMessage = data.message === 'Network folder not configured' 
                ? 'Network folder is not configured. Please set the network folder path above to enable notification controls.'
                : data.message === 'Network folder not found'
                    ? 'The configured network folder does not exist. Please check the network folder path above.'
                    : data.message || 'No notification files found.';
                    
            container.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${warningMessage}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading notification files:', error);
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle"></i>
                Error loading notification files: ${error.message || error}
            </div>
        `;
    });
}

// Clear a specific notification file
function clearNotificationFile(fileName, displayName) {
    if (!confirm(`Are you sure you want to stop notifications for "${displayName}"?\n\nThis will clear all data rows from the Excel file while preserving the table structure.`)) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Clearing...';
    button.disabled = true;
    
    fetch('/api/excel-sync/clear-notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_name: fileName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Successfully stopped notifications for "${displayName}"\n\n${data.message}`);
            // Reload the notification files list
            loadNotificationFiles();
        } else {
            alert(`‚ùå Error: ${data.error || 'Failed to clear notifications'}`);
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error clearing notification file:', error);
        alert(`‚ùå Error clearing notifications: ${error.message || error}`);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Clear all notification files
function clearAllNotifications() {
    if (!confirm('‚ö†Ô∏è WARNING: This will stop ALL notifications by clearing data from all Excel files!\n\nAre you absolutely sure you want to proceed?\n\nThis action cannot be undone.')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Clearing All...';
    button.disabled = true;
    
    fetch('/api/excel-sync/clear-notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})  // No file_name means clear all
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Successfully stopped all notifications!\n\n${data.message}\n\nFiles cleared: ${data.files_cleared}`);
            // Reload the notification files list
            loadNotificationFiles();
        } else {
            alert(`‚ùå Error: ${data.error || 'Failed to clear all notifications'}`);
        }
        
        button.innerHTML = originalText;
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error clearing all notifications:', error);
        alert(`‚ùå Error clearing all notifications: ${error.message || error}`);
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Load notification files on page load
document.addEventListener('DOMContentLoaded', function() {
    loadNotificationFiles();
});

// Auto-refresh status every 30 seconds
setInterval(refreshStatus, 30000);</script>
</script>
{% endblock %}
