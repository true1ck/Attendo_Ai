{% extends "base_fixed.html" %}

{% block title %}Review Mismatches - {{ manager.full_name }}{% endblock %}

{% block extra_css %}
<style>
    .mismatch-card {
        border-left: 4px solid #dc3545;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .mismatch-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .mismatch-pending {
        border-left-color: #ffc107;
    }
    
    .mismatch-approved {
        border-left-color: #28a745;
    }
    
    .mismatch-rejected {
        border-left-color: #dc3545;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    
    .vendor-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .filter-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">
                        <i class="fas fa-exclamation-triangle me-2"></i>Review Mismatches
                    </h1>
                    <p class="text-muted mb-0">{{ manager.team_name }} - {{ manager.full_name }}</p>
                </div>
                <div>
                    <button class="btn btn-primary me-2" onclick="generateMismatchReport()">
                        <i class="fas fa-file-export me-1"></i>Export Report
                    </button>
                    <button class="btn btn-outline-secondary" onclick="detectNewMismatches()">
                        <i class="fas fa-search me-1"></i>Detect New Mismatches
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="summary-card">
                <h3 class="mb-1">{{ summary_stats.total_mismatches }}</h3>
                <small>Total Mismatches</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card">
                <h3 class="mb-1">{{ summary_stats.pending_mismatches }}</h3>
                <small>Pending Review</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card">
                <h3 class="mb-1">{{ summary_stats.vendors_affected }}</h3>
                <small>Vendors Affected</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card">
                <h3 class="mb-1">{{ summary_stats.resolution_rate }}%</h3>
                <small>Resolution Rate</small>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-card">
                <form method="GET" id="filterForm">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label for="statusFilter" class="form-label">Approval Status</label>
                            <select class="form-control" id="statusFilter" name="status" onchange="applyFilters()">
                                <option value="pending" {{ 'selected' if status_filter == 'pending' else '' }}>Pending Review</option>
                                <option value="all" {{ 'selected' if status_filter == 'all' else '' }}>All Statuses</option>
                                <option value="approved" {{ 'selected' if status_filter == 'approved' else '' }}>Approved</option>
                                <option value="rejected" {{ 'selected' if status_filter == 'rejected' else '' }}>Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="vendorFilter" class="form-label">Vendor</label>
                            <select class="form-control" id="vendorFilter" name="vendor" onchange="applyFilters()">
                                <option value="all" {{ 'selected' if vendor_filter == 'all' else '' }}>All Vendors</option>
                                {% for vendor in team_vendors %}
                                <option value="{{ vendor.vendor_id }}" {{ 'selected' if vendor_filter == vendor.vendor_id else '' }}>
                                    {{ vendor.full_name }} ({{ vendor.vendor_id }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>Reset Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mismatches by Vendor -->
    {% if vendor_mismatches %}
        {% for vendor_id, data in vendor_mismatches.items() %}
        <div class="vendor-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-user me-2"></i>{{ data.vendor.full_name }}
                        <small class="text-muted">({{ data.vendor.vendor_id }})</small>
                    </h4>
                    <small class="text-muted">{{ data.vendor.company }} â€¢ {{ data.vendor.department }}</small>
                </div>
                <div>
                    <span class="badge bg-danger me-2">{{ data.pending_count }} Pending</span>
                    <span class="badge bg-secondary">{{ data.total_count }} Total</span>
                </div>
            </div>

            <div class="row">
                {% for mismatch in data.mismatches %}
                <div class="col-lg-6 mb-3">
                    <div class="card mismatch-card mismatch-{{ mismatch.manager_approval.value }}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        {{ mismatch.mismatch_date.strftime('%Y-%m-%d') }}
                                        <span class="badge bg-{{ 'warning' if mismatch.manager_approval.value == 'pending' else 'success' if mismatch.manager_approval.value == 'approved' else 'danger' }}">
                                            {{ mismatch.manager_approval.value.title() }}
                                        </span>
                                    </h6>
                                    
                                    <div class="mb-2">
                                        <strong>Web Status:</strong>
                                        {% if mismatch.web_status %}
                                            <span class="badge bg-info">{{ mismatch.web_status.value.replace('_', ' ').title() }}</span>
                                        {% else %}
                                            <span class="text-muted">Not submitted</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-2">
                                        <strong>Swipe Record:</strong>
                                        <span class="badge bg-secondary">{{ mismatch.swipe_status or 'No record' }}</span>
                                    </div>
                                    
                                    {% if mismatch.vendor_reason %}
                                    <div class="mb-2">
                                        <strong>Vendor Explanation:</strong>
                                        <div class="text-muted small">{{ mismatch.vendor_reason }}</div>
                                        {% if mismatch.vendor_submitted_at %}
                                        <small class="text-muted">Submitted: {{ mismatch.vendor_submitted_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    {% if mismatch.manager_comments %}
                                    <div class="mb-2">
                                        <strong>Manager Comments:</strong>
                                        <div class="text-muted small">{{ mismatch.manager_comments }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 text-end">
                                    {% if mismatch.manager_approval.value == 'pending' and mismatch.vendor_reason %}
                                        <div class="btn-group-vertical d-grid gap-2">
                                            <button class="btn btn-sm btn-success" onclick="reviewMismatch({{ mismatch.id }}, 'approve')">
                                                <i class="fas fa-check me-1"></i>Approve
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="reviewMismatch({{ mismatch.id }}, 'reject')">
                                                <i class="fas fa-times me-1"></i>Reject
                                            </button>
                                        </div>
                                    {% elif mismatch.manager_approval.value == 'pending' %}
                                        <div class="alert alert-warning alert-sm p-2">
                                            <small>
                                                <i class="fas fa-clock me-1"></i>
                                                Waiting for vendor explanation
                                            </small>
                                        </div>
                                    {% else %}
                                        <div class="text-center">
                                            <i class="fas fa-{{ 'check' if mismatch.manager_approval.value == 'approved' else 'times' }} fa-2x text-{{ 'success' if mismatch.manager_approval.value == 'approved' else 'danger' }}"></i>
                                            <div class="small text-muted mt-1">
                                                {{ mismatch.approved_at.strftime('%m/%d %H:%M') if mismatch.approved_at else '' }}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h4 class="text-muted">No Mismatches Found</h4>
            <p class="text-muted">
                {% if status_filter == 'pending' %}
                    All mismatches have been reviewed and resolved.
                {% else %}
                    No attendance mismatches found for the selected criteria.
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function applyFilters() {
    document.getElementById('filterForm').submit();
}

function resetFilters() {
    document.getElementById('statusFilter').value = 'pending';
    document.getElementById('vendorFilter').value = 'all';
    applyFilters();
}

function reviewMismatch(mismatchId, action) {
    const actionText = action === 'approve' ? 'approve' : 'reject';
    const comments = prompt(`Please provide comments for ${actionText}ing this mismatch explanation:`);
    
    if (comments !== null) {
        fetch(`/manager/mismatch/${mismatchId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=${action}&comments=${encodeURIComponent(comments)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`Mismatch explanation ${actionText}ed successfully!`);
                location.reload();
            } else {
                alert('Error: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function generateMismatchReport() {
    const status = document.getElementById('statusFilter').value;
    const vendor = document.getElementById('vendorFilter').value;
    window.open(`/api/export/mismatch-report?status=${status}&vendor=${vendor}&format=excel`, '_blank');
}

function detectNewMismatches() {
    if (confirm('Detect new mismatches from recent swipe data? This may take a moment.')) {
        fetch('/api/detect-mismatches', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`Found ${data.new_mismatches} new mismatches!`);
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}
</script>
{% endblock %}
