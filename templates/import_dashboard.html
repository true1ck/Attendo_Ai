{% extends "base_fixed.html" %}

{% block title %}Data Import & Reconciliation - VendorTime{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-upload me-2"></i>Data Import & Reconciliation</h2>
            <div>
                <button class="btn btn-warning me-2" onclick="runReconciliation()">
                    <i class="fas fa-sync me-1"></i>Run Reconciliation
                </button>
                <button class="btn btn-info" onclick="downloadTemplates()">
                    <i class="fas fa-download me-1"></i>Download Templates
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Swipe Records</h6>
                        <h4 class="mb-0">{{ stats.swipe_records or 0 }}</h4>
                        <small>This month</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-fingerprint fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Leave Records</h6>
                        <h4 class="mb-0">{{ stats.leave_records or 0 }}</h4>
                        <small>This month</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-times fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">WFH Records</h6>
                        <h4 class="mb-0">{{ stats.wfh_records or 0 }}</h4>
                        <small>This month</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-home fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Pending Mismatches</h6>
                        <h4 class="mb-0">{{ stats.pending_mismatches or 0 }}</h4>
                        <small>Need review</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Import Interface -->
<div class="row">
    <div class="col-md-8">
        <!-- Import Options -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Data Import Options</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Swipe Data Import -->
                    <div class="col-md-4">
                        <div class="import-card text-center p-3 border rounded">
                            <div class="mb-3">
                                <i class="fas fa-fingerprint fa-3x text-primary"></i>
                            </div>
                            <h6>Swipe Machine Data</h6>
                            <p class="text-muted small">Import attendance records from biometric systems</p>
                            <div class="mt-2 mb-3">
                                <small class="d-block"><span class="badge bg-success">AP</span> = Present (swiped in)</small>
                                <small class="d-block"><span class="badge bg-danger">AA</span> = Absent (no swipe)</small>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showImportModal('swipe')">
                                <i class="fas fa-upload me-1"></i>Import Swipe Data
                            </button>
                            <div class="mt-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate('swipe')">
                                    <i class="fas fa-download me-1"></i>Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Leave Data Import -->
                    <div class="col-md-4">
                        <div class="import-card text-center p-3 border rounded">
                            <div class="mb-3">
                                <i class="fas fa-calendar-times fa-3x text-success"></i>
                            </div>
                            <h6>Leave Data</h6>
                            <p class="text-muted small">Import leave records from HR systems</p>
                            <button class="btn btn-success btn-sm" onclick="showImportModal('leave')">
                                <i class="fas fa-upload me-1"></i>Import Leave Data
                            </button>
                            <div class="mt-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate('leave')">
                                    <i class="fas fa-download me-1"></i>Template
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- WFH Data Import -->
                    <div class="col-md-4">
                        <div class="import-card text-center p-3 border rounded">
                            <div class="mb-3">
                                <i class="fas fa-home fa-3x text-info"></i>
                            </div>
                            <h6>WFH Data</h6>
                            <p class="text-muted small">Import Work From Home approvals</p>
                            <button class="btn btn-info btn-sm" onclick="showImportModal('wfh')">
                                <i class="fas fa-upload me-1"></i>Import WFH Data
                            </button>
                            <div class="mt-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate('wfh')">
                                    <i class="fas fa-download me-1"></i>Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reconciliation Status -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Reconciliation Status</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshReconciliation()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="reconciliation-status">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Last reconciliation: <span id="last-reconciliation">Never run</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success me-2"></i>Reconciliation Actions</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Swipe vs Web Status
                                    <span class="badge bg-primary" id="swipe-status-matches">-</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Leave vs Attendance
                                    <span class="badge bg-success" id="leave-matches">-</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    WFH vs Office Status
                                    <span class="badge bg-info" id="wfh-matches">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Issues Found</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Status Mismatches
                                    <span class="badge bg-warning" id="status-mismatches">{{ stats.pending_mismatches or 0 }}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Missing Swipe Data
                                    <span class="badge bg-danger" id="missing-swipes">-</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Duplicate Entries
                                    <span class="badge bg-secondary" id="duplicates">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-warning me-2" onclick="runFullReconciliation()">
                            <i class="fas fa-cogs me-1"></i>Full Reconciliation
                        </button>
                        <button class="btn btn-outline-danger" onclick="viewAllMismatches()">
                            <i class="fas fa-list me-1"></i>View All Mismatches
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions & Help -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="validateData()">
                        <i class="fas fa-check-double me-2"></i>Validate Imported Data
                    </button>
                    <button class="btn btn-info" onclick="openReconciliationReport()">
                        <i class="fas fa-chart-line me-2"></i>Reconciliation Report
                    </button>
                    <button class="btn btn-warning" onclick="clearOldData()">
                        <i class="fas fa-trash-alt me-2"></i>Clear Old Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Import Guidelines -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Import Guidelines</h5>
            </div>
            <div class="card-body">
                <h6>File Format Requirements:</h6>
                <ul class="small">
                    <li>Excel files (.xlsx, .xls) or CSV</li>
                    <li>Maximum file size: 10MB</li>
                    <li>Use provided templates for best results</li>
                </ul>
                
                <h6 class="mt-3">Data Validation:</h6>
                <ul class="small">
                    <li>Employee IDs must match existing vendors</li>
                    <li>Dates must be in valid format</li>
                    <li>Duplicate records are automatically skipped</li>
                </ul>
                
                <h6 class="mt-3">Swipe Status Codes:</h6>
                <ul class="small">
                    <li><strong>AP (Attendance Present):</strong> Employee physically swiped card, was in office</li>
                    <li><strong>AA (Attendance Absent):</strong> No card swipe detected, not in office</li>
                    <li>These are compared against employee-submitted status for conflicts</li>
                </ul>
                
                <h6 class="mt-3">Reconciliation Process:</h6>
                <ul class="small">
                    <li>Compares web status vs swipe data (AP/AA codes)</li>
                    <li>Detects leave vs attendance conflicts</li>
                    <li>Identifies missing or incomplete records</li>
                    <li>Generates mismatch reports for review</li>
                    <li><strong>Example:</strong> Employee claims "WFH" but swipe shows "AP" = Mismatch</li>
                </ul>
                
                <div class="alert alert-warning small mt-3">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>Note:</strong> Always run reconciliation after importing new data to identify potential issues.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Select File</label>
                        <input type="file" class="form-control" id="importFile" name="file" accept=".xlsx,.xls,.csv" required>
                        <div class="form-text">Supported formats: Excel (.xlsx, .xls), CSV</div>
                    </div>
                    
                    <div class="mb-3" id="import-preview" style="display: none;">
                        <h6>File Preview:</h6>
                        <div id="preview-content" class="border p-2 small"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="importForm" class="btn btn-primary">
                    <i class="fas fa-upload me-1"></i>Import Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
.import-card {
    transition: all 0.3s ease;
    height: 100%;
}

.import-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

#reconciliation-status .list-group-item {
    background: transparent;
    border-left: none;
    border-right: none;
    padding: 0.5rem 0;
}

.alert-info {
    background-color: #e7f3ff;
    border-color: #b3d7ff;
    color: #004085;
}
</style>

<!-- JavaScript for Import Dashboard -->
<script>
let currentImportType = '';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Import Dashboard loaded');
    loadImportStatistics();
});

function showImportModal(type) {
    currentImportType = type;
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    const modalLabel = document.getElementById('importModalLabel');
    const form = document.getElementById('importForm');
    
    // Update modal title and form action based on type
    switch(type) {
        case 'swipe':
            modalLabel.textContent = 'Import Swipe Machine Data';
            form.action = "/import/swipe-data";
            break;
        case 'leave':
            modalLabel.textContent = 'Import Leave Data';
            form.action = "/import/leave-data";
            break;
        case 'wfh':
            modalLabel.textContent = 'Import WFH Data';
            form.action = "/import/wfh-data";
            break;
    }
    
    modal.show();
}

function runReconciliation() {
    // Redirect to the dedicated reconciliation page; running is only allowed there
    window.location.href = '/admin/reconciliation';
}

function runFullReconciliation() {
    window.location.href = '/admin/reconciliation';
}

function refreshReconciliation() {
    loadImportStatistics();
    alert('Reconciliation status refreshed!');
}

function loadImportStatistics() {
    fetch('/import/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.statistics;
                document.getElementById('last-reconciliation').textContent = stats.last_updated;
                document.getElementById('status-mismatches').textContent = stats.mismatches;
            }
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
}

function downloadTemplates() {
    alert('Template download options:\\n1. Swipe Data Template\\n2. Leave Data Template\\n3. WFH Data Template\\n\\nUse the individual template buttons in each import section.');
}

function downloadTemplate(type) {
    window.location.href = '/import/sample-templates?type=' + encodeURIComponent(type);
}

function viewAllMismatches() {
    window.location.href = '/admin/reconciliation';
}

function validateData() {
    fetch('/import/validate', { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          alert(`Validation complete.\nSwipe duplicates: ${d.stats.swipe_duplicates}\nUnknown vendors: ${d.stats.unknown_vendors}\nLeave/WFH overlaps: ${d.stats.leave_wfh_overlaps}`);
        } else {
          alert('Validation failed: ' + (d.message || 'Unknown error'));
        }
      })
      .catch(e => alert('Validation error: ' + e.message));
}

function openReconciliationReport() {
    window.location.href = '/admin/reconciliation';
}

function clearOldData() {
    if (confirm('Are you sure you want to clear old data? This action cannot be undone.')) {
        alert('Clear Old Data (Demo) - This would archive or delete old reconciliation data');
    }
}

function showLoadingSpinner() {
    // Add loading spinner logic here
    console.log('Loading...');
}

function hideLoadingSpinner() {
    // Hide loading spinner logic here
    console.log('Loading complete');
}

// File preview functionality
document.getElementById('importFile').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
        const previewDiv = document.getElementById('import-preview');
        const previewContent = document.getElementById('preview-content');
        
        previewContent.innerHTML = `
            <strong>File:</strong> ${file.name}<br>
            <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
            <strong>Type:</strong> ${file.type || 'Unknown'}<br>
            <strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleString()}
        `;
        
        previewDiv.style.display = 'block';
    }
});
</script>
{% endblock %}
